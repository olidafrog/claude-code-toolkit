# Bug Fix: Notion Queue Processing "In Progress" Tasks Without Comments

**Date:** 2026-02-05
**Reporter:** Oli
**Fixed by:** Nyx (debug subagent)

---

## Problem Statement

At 2026-02-05 08:06:54 GMT, the `notion-task-queue` cron job:
- Reported "0 tasks with unprocessed comments"
- Still spawned a sub-agent for "Cosmic orb updates" task
- This task was in **"In Progress"** status with **no new comments**

According to Oli, there were NO changes to that task since the last time it was actioned.

---

## Root Cause Analysis

### Evidence from Session Transcript

Session: `c72de944-a164-4672-98f7-27eee09297c3`

1. The `scan-all-for-comments.sh` script was run and returned:
   ```json
   {
     "tasks_with_comments": [],
     "tasks_without_comments": [
       { "name": "Cosmic orb updates", "status": "In Progress", "comment_count": 0 },
       { "name": "Kimi evaluation", "status": "Waiting Review", "comment_count": 0 },
       { "name": "Gemini flash for heartbeats", "status": "To do", "comment_count": 0 },
       { "name": "Investment bot", "status": "To do", "comment_count": 0 }
     ]
   }
   ```

2. The agent (Claude Sonnet 4.5) then reasoned:
   > "I'll now process the tasks in priority order, **skipping the one in Waiting Review**"
   > "1. First: 'Cosmic orb updates' (In Progress, High priority)"

3. The agent correctly skipped "Waiting Review" but **incorrectly processed "In Progress"**.

### The Bug

The `scan-all-for-comments.sh` script output was **ambiguous**:
- `tasks_with_comments` → Clear: process these (feedback loop)
- `tasks_without_comments` → **Ambiguous**: included ALL tasks regardless of status

The SKILL.md decision flow clearly states:
```
No comments + "To do"                    → PROCESS NEW TASK
No comments + "In Progress"              → SKIP (already being worked on!)
No comments + "Waiting Review"           → SKIP (awaiting Oli's review)
```

The agent was left to remember this filtering logic, and it made an error by assuming "In Progress" meant "continue working" when it actually means "already being worked on, skip unless there's new feedback."

---

## The Fix

### 1. Updated `scan-all-for-comments.sh`

Changed the output structure from:
```json
{
  "tasks_with_comments": [...],
  "tasks_without_comments": [...]  // ← Ambiguous!
}
```

To:
```json
{
  "tasks_with_comments": [...],     // PRIORITY 1: Process feedback
  "fresh_tasks": [...],             // PRIORITY 2: "To do" tasks only
  "skip_tasks": [...],              // DO NOT PROCESS!
  "instructions": "PROCESS: tasks_with_comments (PRIORITY 1), then fresh_tasks (PRIORITY 2). DO NOT process skip_tasks!"
}
```

**Key changes:**
- `fresh_tasks` contains ONLY "To do" status tasks (ready for new work)
- `skip_tasks` contains "In Progress" and "Waiting Review" tasks without comments
- Added explicit `instructions` field to guide the agent
- Added visual indicators in stderr output: ✨ for fresh tasks, ⏭️ for skipped

### 2. Updated `SKILL.md` Documentation

- Made the decision flow rules more explicit
- Added rule: "Empty comments + 'In Progress' = SKIP"
- Updated example cron flow to show new categorization
- Added anti-pattern: "DO NOT process anything from `skip_tasks`"
- Updated Key Principles Summary

---

## Correct Behavior (After Fix)

When the cron runs:

1. **Run `scan-all-for-comments.sh`** → Get categorized output
2. **Process `tasks_with_comments`** (PRIORITY 1) - Handle feedback loop
3. **Process `fresh_tasks`** (PRIORITY 2) - Only "To do" tasks
4. **Ignore `skip_tasks`** - "In Progress"/"Waiting Review" without comments

The "Cosmic orb updates" task would now appear in `skip_tasks` and the agent would not process it.

---

## Test Plan

1. Run `scan-all-for-comments.sh` and verify:
   - "To do" tasks without comments appear in `fresh_tasks`
   - "In Progress" tasks without comments appear in `skip_tasks`
   - "Waiting Review" tasks without comments appear in `skip_tasks`
   - Tasks WITH comments appear in `tasks_with_comments` regardless of status

2. Verify the script output includes:
   - `instructions` field with explicit guidance
   - Clear stderr messages showing categorization (✨, ⏭️, ⚠️ icons)

3. Monitor next cron run to ensure:
   - "In Progress" tasks without comments are NOT spawned
   - Only `tasks_with_comments` and `fresh_tasks` are processed

---

## Files Modified

1. `/root/nyx/skills/notion-task-queue/scan-all-for-comments.sh` - Core fix
2. `/root/nyx/skills/notion-task-queue/SKILL.md` - Documentation updates

---

## Prevention

The fix is **defense in depth**:
1. **Script-level**: Pre-categorizes tasks so agent doesn't need to filter
2. **Documentation-level**: Makes rules explicit and adds anti-patterns
3. **Output-level**: Includes `instructions` field in JSON output

This removes the cognitive burden from the agent and makes incorrect behavior structurally impossible.
