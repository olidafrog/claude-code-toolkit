#!/bin/bash
# Generate Phase 2 prompt: Synthesize and Write Report
#
# This phase focuses ONLY on:
# - Reading Phase 1 checkpoint
# - Analyzing and synthesizing findings
# - Writing a comprehensive report
#
# Output: Complete markdown report file
#
# Usage: ./phase2-synthesize.sh <task-id>

set -e

if [ -z "$1" ]; then
  echo "Usage: $0 <task-id>" >&2
  exit 1
fi

TASK_ID="$1"
PHASE_DIR="/tmp/nyx-research-phases/${TASK_ID}"
PHASE1_FILE="${PHASE_DIR}/phase1.json"
PHASE2_FILE="${PHASE_DIR}/phase2.md"
METADATA_FILE="${PHASE_DIR}/metadata.json"

# Verify Phase 1 checkpoint exists
if [ ! -f "$PHASE1_FILE" ]; then
  echo "ERROR: Phase 1 checkpoint not found: $PHASE1_FILE" >&2
  echo "Phase 1 must complete before Phase 2 can start." >&2
  exit 1
fi

# Read task name from metadata
TASK_NAME=$(jq -r '.task_name // "Research Task"' "$METADATA_FILE" 2>/dev/null || echo "Research Task")

# Read Phase 1 data summary
PHASE1_SUMMARY=$(jq -r '
  "Research Question: " + .research_question + "\n" +
  "Sources: " + (.findings | length | tostring) + "\n" +
  "Themes: " + (.themes_identified | join(", ")) + "\n" +
  "Gaps: " + (.gaps_to_address | join(", "))
' "$PHASE1_FILE" 2>/dev/null || echo "[Unable to parse Phase 1 data]")

# Generate the prompt
cat << PROMPT_END
# PHASE 2: Synthesize and Write Report

**Task:** ${TASK_NAME}
**Task ID:** \`${TASK_ID}\`
**Phase:** 2 of 3 (Synthesize)

---

## Your Mission

You are executing **Phase 2** of a phased research task. Your job is to **synthesize the raw research from Phase 1** and **write a comprehensive report**. Do NOT upload to Notion (that's Phase 3).

---

## Phase 1 Summary

${PHASE1_SUMMARY}

**Full Phase 1 data available at:** \`${PHASE1_FILE}\`

**⚠️ CRITICAL: You MUST read the full Phase 1 checkpoint file before starting:**
\`\`\`bash
cat ${PHASE1_FILE}
\`\`\`

---

## Phase 2 Objectives

1. **Read and Understand Phase 1 Data**
   - Load the checkpoint JSON
   - Review all gathered sources and findings
   - Note the identified themes and gaps

2. **Analyze and Synthesize**
   - Identify patterns across sources
   - Draw connections between findings
   - Form evidence-based conclusions

3. **Write Comprehensive Report**
   - Executive summary
   - Detailed findings by theme
   - Recommendations
   - Sources/references

---

## ⚠️ CRITICAL: Output Requirements

You MUST save your complete report to this exact file:

\`\`\`
${PHASE2_FILE}
\`\`\`

**Report Structure (Markdown):**

\`\`\`markdown
# [Task Name]: Research Report

**Research Date:** [Date]
**Task ID:** ${TASK_ID}

## Executive Summary

[2-3 paragraph overview of key findings and recommendations]

## Key Findings

### [Theme 1]
[Detailed findings with evidence from sources]

### [Theme 2]
[Detailed findings with evidence from sources]

[Continue for each theme...]

## Analysis

[Cross-cutting analysis, patterns, insights]

## Recommendations

1. [Actionable recommendation 1]
2. [Actionable recommendation 2]
[Continue...]

## Conclusion

[Summary and next steps]

## Sources

1. [Source 1 with URL]
2. [Source 2 with URL]
[Continue...]

---
*Report generated by Nyx - Phase 2 of phased research*
\`\`\`

---

## Success Criteria

✅ Phase 2 is complete when:
1. You have read ALL Phase 1 data
2. A comprehensive report is written
3. Report is saved to \`${PHASE2_FILE}\`
4. Report includes executive summary, findings, recommendations
5. All sources are properly cited

❌ Phase 2 is NOT complete if:
- Phase 1 data was not read
- Report file doesn't exist or is empty
- Missing executive summary or recommendations
- Sources not cited

---

## What NOT to Do

❌ Do NOT upload to Notion (that's Phase 3)
❌ Do NOT update task status in Notion
❌ Do NOT skip reading the Phase 1 checkpoint
❌ Do NOT write a shallow summary - this should be comprehensive

---

## After Completion

Report back with:
\`\`\`
✅ PHASE 2 COMPLETE
- Task: ${TASK_NAME}
- Report length: [word count or block count]
- Sections: [list main sections]
- Report saved: ${PHASE2_FILE}
- Ready for Phase 3 (Upload)
\`\`\`
PROMPT_END
